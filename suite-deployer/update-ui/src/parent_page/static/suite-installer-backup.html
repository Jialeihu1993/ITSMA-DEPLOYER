<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="x-ua-compatible" content="IE=Edge">
    <meta http-equiv="cache-control" content="no-cache">  
    <link rel="stylesheet" type="text/css" href="css/installer.css">
    <link rel="stylesheet" href="css/hpe-font.css"/>
    <link rel="stylesheet" href="css/jquery-ui.min.css"/>
    <link rel="stylesheet" href="css/sweetalert.css"/>
    
    <script src="js/jquery.min.js"></script>
    <script src="js/handlebars-v4.0.5.js"></script>
    <script src="js/jquery-ui.min.js" ></script>
    <script src="js/jquery.i18n.properties.js"></script>
    <script src="js/sweetalert.min.js"></script>
    <script src="js/initCapabilities.js"></script>
    <script src="js/js.cookie.js"></script>
    <script src="js/fakedata.js"></script>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            min-width: 900px;
            min-height: 550px;
            margin: 0px;
        }

        * {
            font-family: HPEMetricRegular;
        }
        .s-btn {
            border: none;
            width: 100px;
            height: 30px;
            background-color: white;
            outline: none;
            margin-right: 20px;
            margin-bottom: 10px;
            color: black;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 2px 2px 5px #CCCCCC;
        }
        #next_btn{
           margin-right: 30px; 
           float: right;
           background-color: #01A982;
           border: none;
           color: white;
        }
        #back_btn {
           margin-right: 30px; 
           float: right;
           border: solid 2px #01A982;
           background-color: white;
           color: black;
        }
        #cancel_btn {
           margin-left: 30px; 
           float: left;
           border: solid 2px #767676;
           background-color: white;
           display: none;
        }
        #next_btn[disabled="disabled"] {
           color: white;
           background-color: #CCCCCC;
        }
        #back_btn[disabled="disabled"] {
           color: #767676;
           background-color: #CCCCCC;
        }
        #cancel_btn[disabled="disabled"] {
           color: white;
           background-color: #CCCCCC;
        }
        .btn-ui {
            border: 1px solid #01A982;
            width: 100px;
            height: 26px;
            background-color: #01a982;
            outline: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            /*float: right;*/
        }
        /*.s-btn-ui{
            border: 1px solid #01A982;
            width: 100px;
            height: 26px;
            background-color: #01a982;
            outline: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            float: right;
        }*/
        .flag-div{
        	width: 12px;
		    height: 10px;
		    display: inline-block;
		    margin-left: 5px;
        }
        .val-success{
        	background: no-repeat;
        	background-image:url(img/Validate_success.png);
        }
        .val-fail{
        	background: no-repeat;
        	background-image:url(img/Validate_fail.png);
        }
        /*#headerDiv{
        	padding-bottom: 20px;
    		border-bottom: solid 1px #CCCCCC;
        }*/
        .radio-item{
        	/*display: inline-block;
        	width: 125px;
        	height: 35px;
        	color: #01A982;
        	border: solid 1px #01A982;
        	background-color: white;
        	margin-left: 20px;
    		line-height: 30px;*/
        }
        .radio-btn{
        	width: 16px;
    		height: 16px;
    		/*vertical-align: middle;*/
        }
        .radio-font{
        	vertical-align: top;
        	font-size: 16px;
        }
        #setsDiv{
        	/*padding-bottom: 20px;*/
    		border-top: solid 1px #CCCCCC;
        }
        #namespaceDiv{
        	border-top: solid 1px #CCCCCC;
        }
        .fset-item{
	  		display: inline-block;
	  		margin: 5px 5px 5px 5px;
	  		padding: 5px 8px 5px 8px;
	  	
	  	}
	  	.fset-checkbox{
	  		display: inline;
	  		vertical-align: middle;
	  		width: 17px;
	    	height: 17px;
	  	}
	  	.fset-font{
	  		display: inline;
	  		vertical-align: middle;
	  	}
	  	.feature-item{
	  		display: block;
	  		margin: 5px 5px 5px 5px;
	  		padding: 5px 8px 5px 8px;
	  	
	  	}
	  	.feature-checkbox{
	  		display: inline;
	  		vertical-align: middle;
	  		width: 17px;
	    	height: 17px;
	  	}
	  	.feature-font{
	  		display: inline;
	  		vertical-align: middle;
	  	}
	  	
	  	.ui-progressbar {
            position: relative;
        }
        .progress-label {
            position: absolute;
            /*color: white;*/
            left: 46%;
            font-size: 10px;
            font-weight: bold;
            line-height: 10px;
        }
        .ui-progressbar-value{
            background-color: #01A982;
        }
        .p-light{
        	line-height: 10px;
        }
    </style>
</head>

<body id="body" style="display: none;">
<div id="center">
    <div id="section">
        <div id="section_main" align="center">
        	
        </div>
    </div>
</div>
<div id="footer">
    <button id="next_btn" style="" class="footer-button"></button>
    <button id="back_btn" style="" class="footer-button"></button>
    <button id="cancel_btn" style="" class="footer-button"></button>
</div>

<script id="IntroTemplate" type="text/x-handlebars-template" >
	<div style='width:40%;float:left;text-align:center;'>
	    <div class="intro-title" align="left" style="">{{INTRO_TITLE}}</div>
	</div>
	<div style='width:60%;float:left;text-align:left;'>
		<div class="" align="left" style="margin: 20% 10% 15% 10%;">
			<p>
		       {{INTRO_CONTENT1}}
		    </p>
		    <p>
		       {{INTRO_CONTENT2}}
		    </p>
		    <p>
		       {{INTRO_CONTENT3}}
		    </p>
		</div>
	</div>
</script>

<script id="ChooseLicenseTemplate" type="text/x-handlebars-template" >
	<div style='width:40%;float:left;text-align:center;'>
	    <div class="intro-title" align="left" style="">{{CHOOSELICENSE_TITLE}}</div>
	</div>
	<div style='width:60%;text-align:left;float:left;'>
		<div class="" align="left" style="margin: 20% 10% 15% 10%;">
			<div style="height:10%;">
				<span id="yesChooseSpan" style="display: inline-block;height: 30px;">
					<input type='radio' id="yesRadio" value="yes" style='width:17px;height: 17px;vertical-align: middle;' class="lcsChooseRadio"  name='lcsChooseRadio' />
					<font class="lcsChooseText" style="vertical-align: middle;">{{CHOOSELICENSE_YES_CHOOSE}}</font>
				</span>
				<div style="margin-left: 6%"><span id="portalDesc"></span></div>
				<div style="margin-left: 6%">{{CHOOSELICENSE_P2}}
				{{#each lockDetail}}
					<font style="margin-left: 5px;color:#01A982;">{{value}}</font>
				{{/each}}
				</div>
			</div>
			<div>
				<span id="noChooseSpan" style="display: inline-block;height: 30px;">
					<input type='radio' id="noRadio" value="no" style='width:17px;height: 17px;vertical-align: middle;' class="lcsChooseRadio"  name='lcsChooseRadio' />
					<font class="lcsChooseText" style="vertical-align: middle;">{{CHOOSELICENSE_NO_CHOOSE}}</font>
				</span>
				<div style="width: 85%; margin-left: 6%">{{CHOOSELICENSE_P3}}</div>
			</div>
			<div style="margin-top: 10%;">
				<input type="checkbox" id="licenseCheck" name="" value=""><span id="licenseDesc"></span>
				<br>
				<input type="checkbox" id="privacyCheck" name="" value=""><span id="privacyDesc"></span>
			</div>
		</div>
	</div>
</script>
<script id="ChooseSuiteTemplate" type="text/x-handlebars-template" >
	<div style='width:40%;float:left;text-align:center;'>
	    <div class="intro-title" align="left" style="">{{CHOOSESUITE_TITLE}}</div>
	</div>
    <div style='width:60%;text-align:left;float:left;' >
    	<div class="" align="left" style="margin: 20% 10% 15% 10%;">
	        <div id='suiteDiv'>
	        	{{#each suitelist}}
					<button class='s-btn suite-item' suitename='{{suite}}'>{{display_name}}</button>
				{{/each}}
	        </div>
	        <div id='versionDiv'>
	        	{{#each suitelist}}
	        		<div class="suitemap suitemap-{{suite}}" style="display: none;">
	        		{{#each versions}}
	        			{{#if version}}
	        				<div class="version-item">
		    					<input type="radio" style='width:17px;height: 17px;vertical-align: middle;' class="version-radio"  name="suiteVersion"  value="{{version}}"/> 
		    					<font class="version-radio-text" style="vertical-align: middle;">{{version}}</font>
	        				</div>
	        			{{/if}}
					{{/each}}
					</div> 
				{{/each}}
	        </div>
        </div>
    </div>
</script>
<script id="InputLicenseTemplate" type="text/x-handlebars-template" >
	<div style='width:90%;text-align:left;'>
		<h1 style='color: #01A982;'>{{INPUTLICENSE_TITLE}}</h1>
		<div id="selectLcsDiv">
			<p>{{INPUTLICENSE_CONTENT}}</p>
			<br/>
			<div >
				<p>{{INPUTLICENSE_SELECT_LICENSE}}</p>
				<select style="width: 60%;" id="lcsSelect" name="lcsSelect" >
					{{#each lcsData}}
						<option value='{{featureID}}'>{{featureDescription}}-version:{{featureVersion}}</option>
					{{/each}}
				</select>
			</div>
			<div style="margin-top: 20px;">
				
				<form id="addLcsform" name="addLcsform" enctype="multipart/form-data"  method="post">
					<input type="file" style="display:none"  id="file"  name="file" />
				</form>
				<span style="display:inline-block;">{{INPUTLICENSE_ADD_LICENSE}}&nbsp;</span><input type="text" readonly="readonly" name="lcsTitle" id="lcsTitle" style="height: 20px;"/>
				<input type="button" id="selLcsBtn" value="{{INPUTLICENSE_BROWSE_BUTTON}}"  style="margin-left: 8px;vertical-align: middle;" class="btn-ui" />
				<button type="button" id="addLcsBtn" style="vertical-align: middle;" class="btn-ui">{{INPUTLICENSE_ADD_BUTTON}}</button>
			</div>
		</div>
	</div>
</script>
<script id="ConfigurationTemplate" type="text/x-handlebars-template" >
	<div style='width:40%;float:left;text-align:center;'>
	    <div class="intro-title" align="left" style="">{{CONFIGURATION_TITLE}}</div>
	</div>
    <div style='width:60%;text-align:left;float:left;' >
    	<div class="" align="left" style="margin: 20% 10% 15% 10%;">
    		<div style='width:90%;text-align:left;height:35px' >
				<div title='capDescString' style='font-family:HPEMetricSemibold;color:black;font-size:22px;display:inline-block;'>{{currentCap.suite}}</div>
    		</div>
	        <div id='namespaceDiv' style='width:90%;text-align:left'>
	        	<div style='display:inline-block;width: 60%'>
		        	<h3>{{CONFIGURATION_NAMESPACE}}</h3>
			        <!--<div>Please input a combination of lower-case letter and numbers</div>-->
			        <input type='text' id='namespace' style='width:80%;height: 18px'  name='namespace' />
			        <div class='flag-div'></div>
			        
			        <div>&nbsp;<font id="verifyMessage" color="red"></font></div>
	        	</div>
		        <div style='display:inline-block;width: 40%;float: right;'>
			        <h3>{{CONFIGURATION_LABEL}}</h3>
			        <select id='labelSelect' style='width:100%;height: 24px'  name='labelSelect'>
			        	{{#each labels}}
							<option value='{{key}}:{{val}}'>{{key}}</option>
						{{/each}}
			        </select>	
		        </div>
	        </div>
	    </div>
    </div>
</script>
<script id="NFSSetupTemplate" type="text/x-handlebars-template" >
	<div style='width:90%;text-align:left;'>
	   <p>{{NFSSETUP_TITLE}}</p>
	   <h3>{{NFSSETUP_STEP1_TITLE}}</h3>
	   <p>{{NFSSETUP_STEP1_CONTENT}}</p>
	   
	   <h3>{{NFSSETUP_STEP2_TITLE}}</h3>
	   <p>{{NFSSETUP_STEP2_CONTENT}}</p>
	   <p>mkdir -p /var/vols/itom/{{suite}}/{{suite}}-{{namespace}}</p>
	   
	   <h3>{{NFSSETUP_STEP3_TITLE}}</h3>
	   <p>{{NFSSETUP_STEP3_CONTENT}}</p>
	   <p>/var/vols/itom/{{suite}}/{{suite}}-{{namespace}} *(rw,sync,{{#if uid}}anonuid={{uid}},{{/if}}anongid={{gid}},all_squash)</p>
	   
	   <h3>{{NFSSETUP_STEP4_TITLE}}</h3>
	   <p>{{NFSSETUP_STEP4_CONTENT}}</p>
	   <p>sudo exportfs -ra</p>
	   <div id="itsma-expand" style="display: none;">
		   <p>groupadd -g {{gid}} itsma</p>
		   <p>useradd -g {{gid}} -u {{uid}} itsma</p>
		   <p>chown -R itsma:itsma /var/vols/itom/{{suite}}/{{suite}}-{{namespace}}</p>
	   </div>
	</div>
</script>

<script id="SynchronizeTemplate" type="text/x-handlebars-template" >
	<div style='width:90%;text-align:left;'>
	   <h1 style='color: #01A982;'>{{SYNCHRONIZE_TITLE}}</h1>
	   <p>{{SYNCHRONIZE_CONTENT}}</p>
	  <!-- <p>{{SYNCHRONIZE_IMAGES}}</p>-->
	   <p class="p-light">{{SYNCHRONIZE_IMAGES}}</p>
	   <div style="height:150px;overflow-y: auto;border: solid 1px #CCCCCC;padding-left: 10px;">
	   		{{#each images}}
	   			<p class="p-light">{{image}}</p>
			{{/each}}
	   </div>
	   <div style="height:35px;">
		   	<!--<font style="vertical-align: middle;">{{SYNCHRONIZE_CONTENT2}}</font>-->
		   	<font style="vertical-align: middle;">{{SYNCHRONIZE_NOTICE}}</font>
	   </div>
	   <!--
	   <div style="height:35px;">
		   	<li style="vertical-align: middle;">{{SYNCHRONIZE_SYNC_PATH}}</li>
	   </div>
	   <div id="syncDiv" style="height: 75px;">
	   		<button type="button" id="syncBtn" class="btn-ui">{{SYNCHRONIZE_SYNC_BUTTON}}</button>
		   	<div id="progressbar" style="height: 10px;margin-top: 10px;">
			    <div id="progress-label" class="progress-label"></div>
			</div>
			<div>{{SYNCHRONIZE_SUCCESS}}:&nbsp;<span id="syncSuccessNum" style="color: green;">0</span>&nbsp;&nbsp;&nbsp;{{SYNCHRONIZE_FAIL}}:&nbsp;<span id="syncFailureNum" style="color: red;">0</span></div>
	   </div>
	   
	   <div style="height:35px;">
		    <li>{{SYNCHRONIZE_UPLOAD_PATH}}</li>
	   </div>
	   
	   <div style="height:35px">{{SYNCHRONIZE_UPLOAD_HINT}}</div>
	   <div id="uploadDiv" style="height: 70px;">
	   		<div style="">
	   			<form id="upform" name="upform" enctype="multipart/form-data" action="/reg/image/uploadImage" method="post">
					<input type="file" style="display:none"  id="upFile"  name="upFile[]" multiple="multiple"/>
				</form>
				<span style="display:inline-block;"><font color="red">*</font>File:&nbsp;</span><input type="text" readonly="readonly" name="fileTitle" id="fileTitle" style="height: 20px;"/>
				<input type="button" id="upFileBtn" value="{{SYNCHRONIZE_BROWSE_BUTTON}}"  style="margin-left: 8px;vertical-align: middle;" class="btn-ui" />
				<button type="button" id="uploadBtn" style="vertical-align: middle;" class="btn-ui">{{SYNCHRONIZE_UPLOAD_BUTTON}}</button>
	   		</div>
	   		
	   		<div id="progressbar2" style="height: 10px;margin-top: 10px;">
			    <div id="progress-label2" class="progress-label"></div>
			</div>
		   
			<div>{{SYNCHRONIZE_SUCCESS}}:&nbsp;<span style="color: green;" id="uploadSuccessNum">0</span>&nbsp;&nbsp;&nbsp;{{SYNCHRONIZE_FAIL}}:&nbsp;<span id="uploadFailureNum" style="color: red;">0</span></div>
	   </div>
	   -->
	</div>
</script>

<script type="text/javascript">
	
	//etcd need
    var initStep = "Start";
    var userChoose;
    var selectedLicense;
	
	var currentCap;
 	var suiteI18N;
	var currentSuite;
		
	var licenseCheck;
	var privacyCheck;
        	
	//Config
	var suiteReady = false;
	var currentLabel;
	var currentNamespace;
	var currentVersion = null;
	
	var deploymentId;
	//etcd need
	
	
	var csrfToken;
	var authorization = getUrlParam("X-AUTH-TOKEN");
	var acceptLanguage = getUrlParam("ACCEPT-LANGUAGE");
//	var authorization = Cookies.get("xtoken");
	var lastimeRequest = new Date().getTime();
	
	var suitelist;
	var instancelist;
	
	var onNextHandler;
	var onBackHandler;
	var onCancelHandler;
	
	
	
    var iframeUrl = "";
    var $mainFrame = null;
    
    var timer;
	var timer2;
	
	var checktimer;
    
//	var currentEdition;
	
	var frontPath = location.pathname.substring(0,location.pathname.indexOf("/",1));
	
	var language = acceptLanguage || (navigator.browserLanguage?navigator.browserLanguage:navigator.language).replace(/-/g, "_");
	
//	var curSuiteName="";

	function $http(options) {
	    options.count = 0;
	    sendNext(options);
	}

	function  sendNext(options){
	    options.count++;
	    if(!window.parent.isRefreshingToken || options.count > 30){
	        if ( (new Date().getTime() - lastimeRequest) >= 10*60*1000 ) {	// 10 min
	        	window.parent.requestRefreshingToken()		// refresh token
	        }
	        lastimeRequest = new Date().getTime();
	        $.ajax(options);
	        return;
	    }
	    setTimeout(function () {
	        sendNext(options);
	    }, 500);
	}


	$(document).ready(function(){
		
		requestCsrfToken(function(data){
			csrfToken = data;
			requestEtcdStatus(function(status){
				if(status && status.initStep && status.initStep!=null){
					initStep = status.initStep;
			 	
				    userChoose = status.userChoose;
				    selectedLicense = status.selectedLicense;
					
					currentCap = status.currentCap;
					suiteI18N = status.suiteI18N;
					currentSuite = status.currentSuite;
					
					licenseCheck = status.licenseCheck;
					privacyCheck = status.privacyCheck;
					
					//Config
					currentLabel = status.currentLabel;
					currentNamespace = status.currentNamespace;
					currentVersion = status.currentVersion;
				
					deploymentId = status.deploymentId;
				}else{
					initStep = "Start";
				}
				
				//step "SuitePod" spacially
			 	if(initStep == "SuitePod"){
			 		loadBundles(function(){
	        			$("#next_btn").text(FOOTER_NEXT_BUTTON);
		        		$("#next_btn").attr("disabled","disabled");
	        		});
					
		            iframeUrl = 'loading.html?X-AUTH-TOKEN='+authorization;
		            
					var iframeTpl = '<iframe id="mainFrame" name="mainFrame" width="100%"  ' +
		                        'frameborder="0" style="display: block;" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>';
					
		            $("#section_main").children().remove();
		           
		            $(iframeTpl).appendTo("#section_main").prop('src', iframeUrl);
		            
		            if(currentCap && currentCap!=null){
	          			postFeature(deploymentId,currentCap,function(){
			            	requestIframeUrl(deploymentId,currentSuite.suite,currentNamespace ,currentLabel,currentVersion, function (url) {
				                iframeUrl = window.document.location.origin + url;
				                checkIframeOK(iframeUrl, {delay:2000, allTimes:300*1000, beginTime:new Date().getTime()}, function(){
				                    $mainFrame = $("#mainFrame");
				                    $mainFrame.css('height', $('body').height() -90 );
				                    $("#mainFrame").prop('src', iframeUrl);
				                });
				            });
			            });
		            }else{
	            		requestIframeUrl(deploymentId,currentSuite.suite,currentNamespace ,currentLabel,currentVersion, function (url) {
			                iframeUrl = window.document.location.origin + url;
			                checkIframeOK(iframeUrl, {delay:2000, allTimes:300*1000, beginTime:new Date().getTime()}, function(){
			                    $mainFrame = $("#mainFrame");
			                    $mainFrame.css('height', $('body').height() -90 );
			                    $("#mainFrame").prop('src', iframeUrl);
			                });
			            });
		            }
			 	}else{
			 		deploymentId = undefined; 
			 		if(initStep == "Intro"){
				 		initStep = "Start";
				 	}
			 		backStep();
	        		nextStep();
			 	}
	        	$(body).show();
			});
		});
        loadBundles(function(){
        	$("#back_btn").text(FOOTER_BACK_BUTTON);
        	$("#next_btn").text(FOOTER_NEXT_BUTTON);
        	$("#cancel_btn").text(FOOTER_CANCEL_BUTTON);
        });
	});
	
    var loadIntro = function () {
    	initStep = "Intro";
        $("#section_main").children().remove();
		$("#back_btn").attr("disabled","disabled");
		$("#next_btn").removeAttr("disabled");
		loadBundles(function(){
			var myTemplate = Handlebars.compile($("#IntroTemplate").html());
        	$('#section_main').html(myTemplate({
        		INTRO_TITLE:INTRO_TITLE,
				INTRO_CONTENT1:INTRO_CONTENT1,
				INTRO_CONTENT2:INTRO_CONTENT2,
				INTRO_CONTENT3:INTRO_CONTENT3,
        	}));
		})
    }
    var loadChooseLicense = function (lockDetail) {
    	initStep = "ChooseLicense";
        $("#section_main").children().remove();
        $("#back_btn").removeAttr("disabled");
     	$("#next_btn").attr("disabled","disabled");
     	
        loadBundles(function(){
        	var myTemplate = Handlebars.compile($("#ChooseLicenseTemplate").html());
        	$('#section_main').html(myTemplate({
        		"lockDetail":lockDetail,
        		CHOOSELICENSE_TITLE:CHOOSELICENSE_TITLE,
				CHOOSELICENSE_YES_CHOOSE:CHOOSELICENSE_YES_CHOOSE,
				CHOOSELICENSE_NO_CHOOSE:CHOOSELICENSE_NO_CHOOSE,
//				CHOOSELICENSE_P1:jQuery.i18n.prop('CHOOSELICENSE_P1','PORTAL_DESC'),
				CHOOSELICENSE_P2:CHOOSELICENSE_P2,
				CHOOSELICENSE_P3:CHOOSELICENSE_P3,
//				CHOOSELICENSE_P4:jQuery.i18n.prop('CHOOSELICENSE_P4','LICENSE_DESC'),
//				CHOOSELICENSE_P5:jQuery.i18n.prop('CHOOSELICENSE_P5','PRIVACY_DESC'),
			
        	}));
        	$("#portalDesc").html(jQuery.i18n.prop('CHOOSELICENSE_P1','PORTAL_DESC').replace('PORTAL_DESC','<a href="https://www.hpe.com/software/entitlements" target="_blank" style="color:#01A982;">'+ jQuery.i18n.prop('CHOOSELICENSE_HPESW_PORTAL') +'</a>'));
        	$("#licenseDesc").html(jQuery.i18n.prop('CHOOSELICENSE_P4','LICENSE_DESC').replace('LICENSE_DESC','<a href="http://www.hpe.com/software/SWLicensing" target="_blank" style="color:#01A982;">'+ jQuery.i18n.prop('CHOOSELICENSE_HPE_LICENSE') +'</a>'));
        	$("#privacyDesc").html(jQuery.i18n.prop('CHOOSELICENSE_P5','PRIVACY_DESC').replace('PRIVACY_DESC','<a href="http://www8.hp.com/us/en/hpe/privacy/privacy.html" target="_blank" style="color:#01A982;">'+ jQuery.i18n.prop('CHOOSELICENSE_HPE_PRIVACY') +'</a>'));
		})
        
		$(".lcsChooseRadio").click(function(){
    		$(".lcsChooseText").removeClass("text-selected");
    		$(this).siblings(".lcsChooseText").addClass("text-selected");
    		userChoose = $(this).val();
    		trobleCheck();
    	});
        $("#noChooseSpan").click(function(){
        	$("#noRadio")[0].click();
        });
        $("#yesChooseSpan").click(function(){
        	$("#yesRadio")[0].click();
        });

		trobleCheck();

        $("#licenseCheck").click(function() {
        	licenseCheck = $(this)[0].checked;
        	trobleCheck();
        })
        $("#privacyCheck").click(function() {
        	privacyCheck = $(this)[0].checked;
        	trobleCheck();
        })
        
    	if(userChoose == "yes"){
    		$("#yesRadio")[0].click();
    	}else if(userChoose == "no"){
    		$("#noRadio")[0].click();
    	}
    	function trobleCheck(){
			if(licenseCheck){
				$("#licenseCheck")[0].checked = true;
			}
			if(privacyCheck){
				$("#privacyCheck")[0].checked = true;
			}
			if(licenseCheck && privacyCheck && userChoose){
				$("#next_btn").removeAttr("disabled");
			}else{
				$("#next_btn").attr("disabled","disabled");
			}
		}
    }
    
    var loadChooseSuite = function () {
    	initStep = "ChooseSuite";
        $("#section_main").children().remove();
        
        loadBundles(function(){
        	var suitesTemplate = Handlebars.compile($("#ChooseSuiteTemplate").html());
        	$('#section_main').html(suitesTemplate({
        		'suitelist':suitelist,
        		CHOOSESUITE_TITLE:CHOOSESUITE_TITLE,
        	}));
		})
        
        currentSuite = undefined;
        currentVersion = null;
        //init status
        $(".version-radio").each(function(){
    		$(this)[0].checked = false;
    	});
    	$(".version-radio-text").removeClass("text-selected");
    	
    	//click event
    	$(".version-item").click(function(){
    		$(this).children(".version-radio")[0].click();
    	});
    	
    	//click event
    	$(".version-radio").click(function(){
        	var radioval = $(this).val();
        	$(".version-radio-text").removeClass("text-selected");
        	$(this).siblings(".version-radio-text").addClass("text-selected");
        	suitelist.forEach(function (su) {
                if(currentSuite.suite == su.suite){
                	currentSuite.versions.forEach(function (ve) {
                		if(ve.version == radioval){
                			currentVersion = ve;
                		}
                	});
                }
            });
        });
    	
    	//switch suite
		$('.suite-item').click(function () {
			$('.suite-item').css({
                'background-color': 'white',
                'color':'black',
                'box-shadow': '2px 2px 5px #CCCCCC'
            });
            $(this).css({
                'background-color': '#01a982',
                'color':'white',
                'box-shadow': 'none'
                
            });
            var currentSuiteName =  $(this).attr('suitename');
            suitelist.forEach(function (su) {
                if(currentSuiteName == su.suite){
                	currentSuite = su;
                	$(".version-radio").each(function(){
                		$(this)[0].checked = false;
                	});
                	$(".version-radio-text").removeClass("text-selected");
                	$(".suitemap").hide();
                	$(".suitemap-"+currentSuite.suite).show();
                	$(".suitemap-"+currentSuite.suite).children(".version-item").children(".version-radio:last")[0].click();
                }
            });
        });
        
		if(currentSuite && currentSuite.suite !=null){
			$('.suite-item[suitename = "'+currentSuite.suite+'"]').click();
		}
    }
    var loadInputLicense = function (lcsData) {
    	initStep = "InputLicense";
//  	SelectOrUpload = "Select";
        $("#section_main").children().remove();
        
        requestExtLicense(function(data){
        	loadBundles(function(){
	        	var inputLicenseTemplate = Handlebars.compile($("#InputLicenseTemplate").html());
	        	$('#section_main').html(inputLicenseTemplate({
	        		'lcsData':data,
	        		INPUTLICENSE_TITLE:INPUTLICENSE_TITLE,
					INPUTLICENSE_CONTENT:INPUTLICENSE_CONTENT,
					INPUTLICENSE_SELECT_LICENSE:INPUTLICENSE_SELECT_LICENSE,
					INPUTLICENSE_ADD_LICENSE:INPUTLICENSE_ADD_LICENSE,
					INPUTLICENSE_BROWSE_BUTTON:INPUTLICENSE_BROWSE_BUTTON,
					INPUTLICENSE_ADD_BUTTON:INPUTLICENSE_ADD_BUTTON,
	        	}));
			})
	        
	        if(selectedLicense && selectedLicense != null){
	        	$("#lcsSelect").val(selectedLicense);
	        }else{
	        	selectedLicense = $("#lcsSelect").val();
	        }
	        
	        $("#lcsSelect").change(function(){
	        	selectedLicense = $(this).val();
	        });
	        
	        $("#file").change(function(){
				var upfiles = document.addLcsform["file"].files;
				if(upfiles.length>0){
					document.getElementById("lcsTitle").value = upfiles[0].name;
					
				}
		    });
			$("#selLcsBtn").click(function(){
				$("#file")[0].click();
		    });
        	$("#addLcsBtn").click(function(){
        		console.log($("#file").val())
        		if($("#file").val()!=null && $("#file").val()!=""){
        			var formData = new FormData(document.getElementById("addLcsform"));
	        		$http({
			              url: frontPath +  '/urest/v1.1/license-manager/license',
			              type: 'post',
			              
			              data:formData,
			              headers:{
			              	'X-AUTH-TOKEN': authorization,
			              	'X-CSRF-TOKEN': csrfToken,
			              },
			              contentType:false,
			              processData:false,
			              success: function (data) {
			              	if(data.status != "SUCCESS"){
			              		loadBundles(function(){
			        				sweetAlert({
									  title: "",
									  text: ALERT_MESSAGE_ADD_LICENSE_FAIL,
									  allowOutsideClick: true,
									});
			        			});
			              	}else{
			              		loadInputLicense();
			              	}
							 
			              },
			              error: function (res) {
		              		loadBundles(function(){
		        				sweetAlert({
								  title: "",
								  text: ALERT_MESSAGE_ADD_LICENSE_FAIL,
								  allowOutsideClick: true,
								});
		        			});
			                console.log(res);
			              }
			        });
        		}else{
        			loadBundles(function(){
        				sweetAlert({
						  title: "",
						  text: ALERT_MESSAGE_CHOOSE_LICENSE,
						  allowOutsideClick: true,
						});
        			});
        		}
		    });
        	
        });
    }
    var loadShowFeatures = function () {
    	initStep = "ShowFeatures";
    	$("#section_main").children().remove();
    	
//  	currentCap = capObj.suiteFeature;
    	if(currentCap && currentCap != null){
    		initCapabilities(suiteI18N);
    	}else{
    		loadBundles(function(){
    			$("#section_main").append(
			        "<h3>"+SHOWFEATURES_CONTENT2+"</h3>"
			    );
    		});
    	}
    }
    var loadConfiguration = function (instances,labels,curCap) {
    	initStep = "Configuration";
    	$("#section_main").children().remove();
        
        loadBundles(function(){
			var configTemplate = Handlebars.compile($("#ConfigurationTemplate").html());
        	$('#section_main').html(configTemplate({
        		'labels':labels,
        		'currentCap': curCap,
        		CONFIGURATION_TITLE:CONFIGURATION_TITLE,
				CONFIGURATION_NAMESPACE:CONFIGURATION_NAMESPACE,
				CONFIGURATION_LABEL:CONFIGURATION_LABEL,
        	}));
		});
        
        $("#namespace").val(currentNamespace);
        $("#namespace").blur(function(){
        	currentNamespace = $("#namespace").val().trim();
        	verifyNamespace(currentNamespace);
        });
        $("#namespace").change(function(){
        	$(".flag-div").removeClass("val-success").removeClass("val-fail");
        	$("#verifyMessage").text("");
        });
        $("#namespace").keyup(function(){
        	$(".flag-div").removeClass("val-success").removeClass("val-fail");
        	$("#verifyMessage").text("");
        });
        
        if(currentLabel && currentLabel != null){
        	$("#labelSelect").val(currentLabel);
        }else{
        	currentLabel = $("#labelSelect").val();
        }
        
        $("#labelSelect").change(function(){
        	currentLabel = $(this).val();
        });
    }
	var loadNFSSetup = function () {
    	//存入etcd
//		console.log(currentSuite);
		
		initStep = "NFSSetup";
		$("#section_main").children().remove();
		
		loadBundles(function(){
			var nfsTemplate = Handlebars.compile($("#NFSSetupTemplate").html());
	        $('#section_main').html(nfsTemplate({
	        	"suite":currentSuite.suite,
	        	"gid":currentSuite.gid,
	        	"uid":currentSuite.uid,
	        	"namespace":currentNamespace,
	        	NFSSETUP_TITLE:NFSSETUP_TITLE,
				NFSSETUP_STEP1_TITLE:NFSSETUP_STEP1_TITLE,
				NFSSETUP_STEP1_CONTENT:NFSSETUP_STEP1_CONTENT,
				NFSSETUP_STEP2_TITLE:NFSSETUP_STEP2_TITLE,
				NFSSETUP_STEP2_CONTENT:NFSSETUP_STEP2_CONTENT,
				NFSSETUP_STEP3_TITLE:NFSSETUP_STEP3_TITLE,
				NFSSETUP_STEP3_CONTENT:NFSSETUP_STEP3_CONTENT,
				NFSSETUP_STEP4_TITLE:NFSSETUP_STEP4_TITLE,
				NFSSETUP_STEP4_CONTENT:NFSSETUP_STEP4_CONTENT,
	        }));
		});
        if(currentSuite.suite == "itsma"){
        	$("#itsma-expand").show();
        }
        
    }
	var loadSynchronize = function () {
		
		initStep = "Synchronize";
		$("#section_main").children().remove();
		
		//清除计时器
		if(checktimer){
			clearTimeout(checktimer);
		}
		//设置为未加载页面
		suiteReady = false;
        
        loadBundles(function(){
        	var syncTemplate = Handlebars.compile($("#SynchronizeTemplate").html());
        	$('#section_main').html(syncTemplate({ 
        		"images": currentCap.images,
        		SYNCHRONIZE_TITLE:SYNCHRONIZE_TITLE,
				SYNCHRONIZE_CONTENT:SYNCHRONIZE_CONTENT,
				SYNCHRONIZE_CONTENT2:SYNCHRONIZE_CONTENT2,
				SYNCHRONIZE_NOTICE:SYNCHRONIZE_NOTICE,
				SYNCHRONIZE_IMAGES:SYNCHRONIZE_IMAGES,
				SYNCHRONIZE_SYNC_PATH:SYNCHRONIZE_SYNC_PATH,
				SYNCHRONIZE_UPLOAD_PATH:SYNCHRONIZE_UPLOAD_PATH,
				SYNCHRONIZE_UPLOAD_HINT:SYNCHRONIZE_UPLOAD_HINT,
				SYNCHRONIZE_SUCCESS:SYNCHRONIZE_SUCCESS,
				SYNCHRONIZE_FAIL:SYNCHRONIZE_FAIL,
				SYNCHRONIZE_SYNC_BUTTON:SYNCHRONIZE_SYNC_BUTTON,
				SYNCHRONIZE_BROWSE_BUTTON:SYNCHRONIZE_BROWSE_BUTTON,
				SYNCHRONIZE_UPLOAD_BUTTON:SYNCHRONIZE_UPLOAD_BUTTON,
        	}));
        });
        
        
        //----------------------progressbar1-------------------
        var progressbar = $("#progressbar");
        var progressLabel = $("#progress-label");

        progressbar.progressbar({
            value: true,
            change: function() {
                progressLabel.text( progressbar.progressbar( "value" ) + "%" );
            },
            complete: function() {
                progressLabel.text( "Complete!" );
            }
        });
//		getSyncProgress();
		$("#syncBtn").click(function(){
//			clearTimeout(timer);
//			timer = setTimeout(getSyncProgress, 3000);
//			progressbar.progressbar( "value", 0);
//			progressLabel.text( jQuery.i18n.prop(PROGRESS_LOADING) );
//			$("#syncSuccessNum").text(0);
//			$("#syncFailureNum").text(0);
						
			 $http({
                url: '/reg/image/SyncProgress',
                type: 'GET',
                headers:{'Authorization': authorization},
                cache:false,
                success: function (res) {
                    if(res.status==1){
                    	loadBundles(function(){
	        				sweetAlert({
							  title: "",
							  text: ALERT_MESSAGE_TASK_INPROGRESS,
							  allowOutsideClick: true,
							});
	        			});
                        clearTimeout(timer);
						timer = setTimeout(getSyncProgress, 3000);
                    }else if(res.status==0){
                        var imagesMap = {};
                        currentCap.images.forEach(function(e){
                        	var it = e.image;
                        	var itTag = it.substring(it.lastIndexOf(":")+1,it.length);
                        	var itName = it.substring(0,it.lastIndexOf(":"));
                        	imagesMap[itName] = [itTag];
                        });
                        console.log(imagesMap);
                 		
                        var myform = new FormData();
						myform.append("imageList", JSON.stringify(imagesMap));
						
						clearTimeout(timer);
						timer = setTimeout(getSyncProgress, 3000);
						progressbar.progressbar( "value", 0);
						progressLabel.text( jQuery.i18n.prop(PROGRESS_LOADING) );
						$("#syncSuccessNum").text(0);
						$("#syncFailureNum").text(0);
                    	$http({
			                url: '/reg/image/syncImages',
			                type: 'POST',
			                headers:{'Authorization': authorization},
			                data: myform,
			                
			                processData:false,
			                contentType:false,
			                
			                success: function (res) {
//									clearTimeout(timer);
//									timer = setTimeout(getSyncProgress, 3000);
			                },
			                error: function (res) {
			                	console.log("-------------network error--------------")
                				console.log(res)
			                    progressLabel.text(jQuery.i18n.prop(PROGRESS_ERROR));
			                }
			            });
                    }else{
                    	console("other return value");
                    }
                },
                error: function (res) {
                	console.log("-------------network error--------------")
                	console.log(res)
                    progressLabel.text(jQuery.i18n.prop(PROGRESS_ERROR));
                }
            });
			
		});
		function getSyncProgress() {
            $http({
                url: '/reg/image/SyncProgress',
//                url: '1.json',
                type: 'GET',
                headers:{'Authorization': authorization},
                cache:false,
                success: function (res) {
                	console.log(res);
					$("#syncSuccessNum").text(res.successNum);
					$("#syncFailureNum").text(res.failureNum);
                    if(res.status==1){
                    	if(res.currentIndex < 0){
                    		progressbar.progressbar( "value", 0);
                    	}else{
                    		var rate = (res.currentIndex*5+res.currentStep)/(res.totalIndex*5);
                        	progressbar.progressbar( "value",  parseInt(rate*10000)/100  );
						}
//                      clearTimeout(timer);
                        timer = setTimeout(getSyncProgress, 3000);
                    }else if(res.status==0){
                    	clearTimeout(timer);
                        progressbar.progressbar( "value", 100);
                    }else{
                    	console("other return value");
                    }
                },
                error: function (res) {
                	progressLabel.text(jQuery.i18n.prop(PROGRESS_ERROR));
                }
            });
        }
 		//----------------------progressbar1-------------------
		
		//--------------progressbar2-------------------------
        var progressbar2 = $("#progressbar2");
        var progressLabel2 = $("#progress-label2");

        progressbar2.progressbar({
            value: true,
            change: function() {
                progressLabel2.text( progressbar2.progressbar( "value" ) + "%" );
            },
            complete: function() {
                progressLabel2.text( "Complete!" );
            }
        });
        
        $("#upFile").change(function(){
			var upfiles = document.upform["upFile[]"].files;
			var path = "";
			for(var i=0;i<upfiles.length;i++){
				if(i < upfiles.length-1){
					path = path + upfiles[i].name+",";
				}else{
					path = path + upfiles[i].name;
				}
			}
			document.getElementById("fileTitle").value = path;
	    });

		$("#upFileBtn").click(function(){
			$("#upFile")[0].click();
	    });
	    
	    $("#uploadBtn").click(function(){
			var upfiles = document.upform["upFile[]"].files;

			if(upfiles.length>0){
				
//				clearTimeout(timer2);
//				timer2 = setTimeout(getUploadProgress, 3000);
				
				
//				$("#uploadSuccessNum").text(0);
//				$("#uploadFailureNum").text(0);
				
				 $http({
	                url: '/reg/image/UploadProgress',
	                type: 'GET',
	                headers:{'Authorization': authorization},
	                cache:false,
	                success: function (res) {
	                	
	                    if(res.status == 1){
	                    	loadBundles(function(){
		        				sweetAlert({
								  title: "",
								  text: ALERT_MESSAGE_TASK_INPROGRESS,
								  allowOutsideClick: true,
								});
		        			});
	                      	clearTimeout(timer2);
							timer2 = setTimeout(getUploadProgress, 3000);
	                    }else if(res.status == 0){
	                    	var formData = new FormData(document.getElementById("upform"));
	                    	$http({
				                url: '/reg/image/ChangeUploadStatus/2',
				                type: 'GET',
				                headers:{'Authorization': authorization},
				                success: function (res) {
				                	progressbar2.progressbar( "value", 0);
									progressLabel2.text( jQuery.i18n.prop(PROGRESS_LOADING) );
									$("#uploadSuccessNum").text(0);
									$("#uploadFailureNum").text(0);
									clearTimeout(timer2);
									timer2 = setTimeout(getUploadProgress, 3000);
			                    	$http({
						                url: '/reg/image/uploadImage',
						                type: 'POST',
						                headers:{'Authorization': authorization},
						                data: formData,
						                processData:false,
						                contentType:false,
						                error: function (res) {
						                	console.log("uploadImage error:reset status to 0");
			                				console.log(res)
						                    progressLabel2.text(jQuery.i18n.prop(PROGRESS_ERROR));
						                    $http({
								                url: '/reg/image/ChangeUploadStatus/0',
								                type: 'GET',
								                headers:{'Authorization': authorization},
								                error:function (res) {
								                	console.log("reset status error:");
			                						console.log(res)
								                },
								            });
						                }
						            });
				                	
				                },
				                error: function (res) {
				                	console.log("ChangeUploadStatus:request maybe timeout");
	                				console.log(res)
				                }
				            });
	                    }else{
	                    	console.log("Other return value.");
	                    }
	                },
	                error: function (res) {
	                	console.log("testUploadProgress:token maybe lost.");
	                	console.log(res)
	                    progressLabel2.text(jQuery.i18n.prop(PROGRESS_ERROR));
	                }
	            });
			}else{
				loadBundles(function(){
    				sweetAlert({
					  title: "",
					  text: ALERT_MESSAGE_CHOOSE_TARFILE,
					  allowOutsideClick: true,
					});
    			});
			}
	    });
	    function getUploadProgress() {
            $http({
                url: '/reg/image/UploadProgress',
                type: 'GET',
                headers:{'Authorization': authorization},
                cache:false,
                success: function (res) {
//              	console.log(res);
					$("#uploadSuccessNum").text(res.successNum);
					$("#uploadFailureNum").text(res.failureNum);
                    if(res.status==1 || res.status==2){
                    	if(res.currentIndex < 0){
                    		progressbar2.progressbar( "value", 0);
                    	}else{
                    		console.log(res.totalIndex);
                    		if(res.totalIndex==0){
                    			progressbar2.progressbar( "value", 0);
                    		}else{
                    			var rate = (res.currentIndex*6+res.currentStep)/(res.totalIndex*6);
                        		progressbar2.progressbar( "value",  parseInt(rate*10000)/100  );
                    		}
						}
                        timer2 = setTimeout(getUploadProgress, 3000);
                    }else if(res.status==0){
                    	clearTimeout(timer2);
                        progressbar2.progressbar( "value", 100);
                    }else{
                    	console.log("Other return value.")
                    }
                },
                error: function (res) {
                	console.log("getUploadProgress:token maybe lost.");
                	console.log(res)
                	progressLabel2.text(jQuery.i18n.prop(PROGRESS_ERROR));
                }
            });
        }
        //--------------progressbar2-------------------------
    }
	
	
//  nextStep();
    
    $("#next_btn").click(nextStep);
    
    function nextStep() {
    	if (initStep == "Start") {
    		initStep = "Intro";
    		saveStep(initStep,function(){
    			loadIntro();
    		});
        } 
        else if (initStep == "Intro") {
        	requestLockId(function(lockDetail){
        		initStep = "ChooseLicense";
        		saveStep(initStep,function(){
        			loadChooseLicense(lockDetail);
        		});
        	});
        } 
        //sep
        else if (initStep == "ChooseLicense") {
//      	console.log($('input[name="lcsChooseRadio"]:checked').val());
        	if($('input[name="lcsChooseRadio"]:checked').val()){
        		userChoose = $('input[name="lcsChooseRadio"]:checked').val();
        	}
        	//加载SuiteList
        	requestSuiteInfo(function(suites){
        		if(privacyCheck && licenseCheck){
        			if(userChoose == "yes"){
	        			initStep = "InputLicense";
	        			saveStep(initStep,function(){
	        				loadInputLicense();
	        			});
		        	}
		        	else if(userChoose == "no"){
		        		initStep = "ChooseSuite";
	        			saveStep(initStep,function(){
		        			loadChooseSuite();
		        		});
		        	}
		        	else{
		        		loadBundles(function(){
		    				sweetAlert({
							  title: "",
							  text: ALERT_MESSAGE_CHOOSE_HAS_LICENSE,
							  allowOutsideClick: true,
							});
		    			});
		        	}
        		}else{
        			loadBundles(function(){
	    				sweetAlert({
						  title: "",
						  text: ALERT_MESSAGE_PRIVACYCHECK_LICENSECHECK,
						  allowOutsideClick: true,
						});
	    			});
        		}
        		
	        	
        	});
        }
        //road 1
        else if (initStep == "InputLicense") {
			if($("#lcsSelect").val()){
				selectedLicense = $("#lcsSelect").val();
			}
			
			if(selectedLicense && selectedLicense != null){
				requestSuiteInfo(function(suites){
					currentSuite = undefined;
					currentVersion = null;
					
					suitelist.forEach(function (suite) {
		        		suite.versions.forEach(function (version) {
		        			if(version.license_id && version.license_id!=null){
		        				version.license_id.forEach(function (editionId) {
			        				if(editionId == selectedLicense){
			        					currentSuite = suite;
			        					currentVersion = version;
			        				}
			        			});
		        			}
		        		});
			        });
					if(currentSuite && currentSuite.suite !=null){
						requestCapabilities(selectedLicense,currentSuite.suite,currentVersion, function(data){
							initStep = "ShowFeatures";
							saveStep(initStep,function(){
								loadShowFeatures(data);
								//init edition
//								$(".radio-btn[id='"+currentCap.initial_edition_selected+"']")[0].click();
		        			});
						});
					}else{
						loadBundles(function(){
		    				sweetAlert({
							  title: "",
							  text: ALERT_MESSAGE_NOCORRESPOND_SUITE,
							  allowOutsideClick: true,
							});
		    			});
					}
					
					
				});
			}
			else{
				loadBundles(function(){
    				sweetAlert({
					  title: "",
					  text: ALERT_MESSAGE_LICENSE_EMPTY,
					  allowOutsideClick: true,
					});
    			});
			}
        }
        //road 2
        else if (initStep == "ChooseSuite") {
        	if(!currentSuite || currentSuite.suite == null){
        		loadBundles(function(){
    				sweetAlert({
					  title: "",
					  text: ALERT_MESSAGE_CHOOSE_SUITE,
					  allowOutsideClick: true,
					});
    			});
        		return;
        	}
        	if(!currentVersion || currentVersion == null){
				loadBundles(function(){
    				sweetAlert({
					  title: "",
					  text: ALERT_MESSAGE_CHOOSE_VERSION,
					  allowOutsideClick: true,
					});
    			});
        		return;
        	}
        	
    		requestCapabilities(null,currentSuite.suite,currentVersion, function(data){
    			initStep = "ShowFeatures";
    			saveStep(initStep,function(){
    				loadShowFeatures(data);
    				//init edition
//					$(".radio-btn[id='"+currentCap.initial_edition_selected+"']")[0].click();
		        });
			});
        		
        }
        else if (initStep == "ShowFeatures") {
        	requestInstances(function (instances) {
        		requestLabels(function(labels){
        			initStep = "Configuration";
        			saveStep(initStep,function(){
	    				loadConfiguration(instances,labels,currentCap);
			        });
        		});
            });
        }
        else if (initStep == "Configuration") {
        	requestInstances(function (instances) {
        		if($("#namespace").val()){
	        		currentNamespace = $("#namespace").val().trim();
	        	}
	//      	currentNamespace = $("#namespace").val().trim();
	        	if(verifyNamespace(currentNamespace)){
	        		initStep = "NFSSetup";
	        		saveStep(initStep,function(){
	    				loadNFSSetup();
			        });
	        	}
            });
        }
        else if (initStep == "NFSSetup") {
        	initStep = "Synchronize";
        	saveStep(initStep,function(){
				loadSynchronize();
	        });
        }
        else if (initStep == "Synchronize") {
        	initStep = "SuitePod";
        	saveStep(initStep,function(){
        		loadBundles(function(){
        			$("#next_btn").text(FOOTER_NEXT_BUTTON);
	        		$("#next_btn").attr("disabled","disabled");
        		});
				
	            iframeUrl = 'loading.html?X-AUTH-TOKEN='+authorization+'&ACCEPT-LANGUAGE='+acceptLanguage;
	            
				var iframeTpl = '<iframe id="mainFrame" name="mainFrame" width="100%" height="100%" ' +
	                        'frameborder="0" style="display: block;" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>';
				
	            $("#section_main").children().remove();
	           
	            $(iframeTpl).appendTo("#section_main").prop('src', iframeUrl);
	//          console.log(currentSuite.suite);
	//          console.log(currentNamespace);
	            if(currentCap && currentCap!=null){
	            	requestDeploymentId(function(depid){
	            		deploymentId = depid;
	          			postFeature(deploymentId,currentCap,function(){
			            	requestIframeUrl(deploymentId,currentSuite.suite,currentNamespace ,currentLabel,currentVersion, function (url) {
				                iframeUrl = window.document.location.origin + url;
		//		                iframeUrl = window.document.location.origin + "/aaa";
				                checkIframeOK(iframeUrl, {delay:2000, allTimes:300*1000, beginTime:new Date().getTime()}, function(){
				                    $mainFrame = $("#mainFrame");
				                    $mainFrame.css('height', $('body').height() -90 );
				                    $("#mainFrame").prop('src', iframeUrl);
				                });
				            });
			            });
	            	})
	            	
	            }else{
	            	requestDeploymentId(function(depid){
	            		deploymentId = depid;
	            		requestIframeUrl(deploymentId,currentSuite.suite,currentNamespace ,currentLabel,currentVersion, function (url) {
			                iframeUrl = window.document.location.origin + url;
		//	                iframeUrl = window.document.location.origin + "/aaa";
			                checkIframeOK(iframeUrl, {delay:2000, allTimes:300*1000, beginTime:new Date().getTime()}, function(){
			                    $mainFrame = $("#mainFrame");
			                    $mainFrame.css('height', $('body').height() -90 );
			                    $("#mainFrame").prop('src', iframeUrl);
			                });
			            });
	            	})
	            }
	        });
        }
        else if (initStep == "SuitePod") {
        	//此时点击的是refresh
        	if(!suiteReady){
        		initStep = "Synchronize";
        		nextStep();
        	}else{
        		var ret = onNextHandler();
	            if(!ret){
	//              $(this).attr('disabled', true);
	            }else{
	            	loadIntro();
	            	loadBundles(function(){
	            		$("#cancel_btn").hide();
		        		$("#next_btn").text(FOOTER_NEXT_BUTTON).removeAttr("disabled");
	        		});
	            }
        	}
        }
        
        
    }
    
    function backStep(){
    	if (initStep == "ChooseLicense") {
            loadIntro();
        } 
        //road 1
        else if (initStep == "InputLicense") {
            requestLockId(function(lockDetail){
        		loadChooseLicense(lockDetail);
        	});
        }
        //road 2
        else if (initStep == "ChooseSuite") {
			requestLockId(function(lockDetail){
        		loadChooseLicense(lockDetail);
        		$("#next_btn").removeAttr("disabled");
        	});
        }
        else if (initStep == "ShowFeatures") {
            if(userChoose == "yes"){
				loadInputLicense();
            }
            else if(userChoose == "no"){
            	loadChooseSuite();
            }
        }
        else if (initStep == "Configuration") {
            loadShowFeatures(currentCap);
        }
        else if (initStep == "NFSSetup") {
        	requestInstances(function (instances) {
        		requestLabels(function(labels){
        			loadConfiguration(instances,labels,currentCap);
        		});
            });
        }
        else if (initStep == "Synchronize") {
        	loadNFSSetup();
        }
        else if (initStep == "SuitePod") {
        	if(!suiteReady){
        		loadBundles(function(){
        			$("#cancel_btn").hide();
	        		$("#next_btn").text(FOOTER_NEXT_BUTTON).removeAttr("disabled");
        		});
        		loadSynchronize();
        	}else{
        		var ret = onBackHandler();
	            if(!ret){
	//              $(this).attr('disabled', true);
	            }else{
	            	loadBundles(function(){
	            		$("#cancel_btn").hide();
		        		$("#next_btn").text(FOOTER_NEXT_BUTTON).removeAttr("disabled");
	        		});
	            	loadSynchronize();
	            }
        	}
        }
    }
    $("#back_btn").click(backStep);
    $("#cancel_btn").click(function(){
    	var ret = onCancelHandler();
    	//uninstall instance
    	$http({      
            url: frontPath + '/urest/v1.1/deployment/'+deploymentId+'/k8s-instance',
            type: 'post',
            data: JSON.stringify({"action":"delete"}),
            headers:{
		              	'X-AUTH-TOKEN': authorization,
		              	'X-CSRF-TOKEN': csrfToken,
		              },
            success: function (data) {
            	initStep = "NFSSetup";
    			nextStep();
            },
            error: function (err) {
                console.log(err);
            }
        });
    });
    
    
    window.onload = function () {
//      resizeComponent();
    }
    window.onresize = function () {
//      resizeComponent();
        $mainFrame && $mainFrame.css('height', $('body').height() -90 );
    }
    function verifyNamespace(namespace){
    	if(namespace && namespace.length>0){
    		var flag = false;
    		instancelist.forEach(function (e) {
        		if( e.namespace == namespace){
        			flag = true;
        		}
	        });
	        if(flag){
	        	$(".flag-div").removeClass("val-success").addClass("val-fail");
	        	loadBundles(function(){
	        		$("#verifyMessage").text(CONFIGURATION_NAMESPACE_EXIST);
	        	});
	        	return false;
	        }
			var rex = /^[a-z0-9]+$/ ;
	       	if(!rex.test(namespace)){
	       		$(".flag-div").removeClass("val-success").addClass("val-fail");
	       		loadBundles(function(){
	        		$("#verifyMessage").text(CONFIGURATION_NAMESPACE_NOMATCH);
	        	});
	        	return false;
	       	}
	       	
            $(".flag-div").removeClass("val-fail").addClass("val-success");
            $("#verifyMessage").text("");
            return true;
        }else{
        	$(".flag-div").removeClass("val-success").addClass("val-fail");
        	loadBundles(function(){
	        	$("#verifyMessage").text(CONFIGURATION_NAMESPACE_EMPTY);
	        });
    		return false;
    	}
    }

	//show cap
    function showObj() {
		console.log(currentCap);
    }

    function requestIframeUrl(deploymentId,suiteName,namespace,label,version, cb) {
    	var labelKeyAndValue = label.split(":");
    	var labelKey = null;
    	var labelValue = null;
    	if(labelKeyAndValue.length == 2){
    		labelKey = labelKeyAndValue[0];
    		labelValue = labelKeyAndValue[1];
    	}
    	var paramMap = {
		  "labelKey": labelKey,
		  "labelValue": labelValue,
		  "namespace": namespace,
		  "suite": suiteName,
		  "version": version.version,
		}
    	console.log(paramMap);
    	
        $http({
            url: frontPath + '/urest/v1.1/deployment/'+deploymentId+'/suite-configuration',
            type: 'post',
            cache:false,
            data: JSON.stringify(paramMap),
            contentType:"application/json",
            headers:{
		              	'X-AUTH-TOKEN': authorization,
		              	'X-CSRF-TOKEN': csrfToken,
		              },
            success: function (data) {
            	console.log(data);
                cb('/suiteConfig/' + suiteName + '/configuration.html');
            },
            error: function (err) {
                console.log(err);
            }
        });
    }
	
	//TODO
	//----------------------exp-------------------------
    //返回所有suite instances
    function requestInstances(cb) {
      $http({
          url: frontPath + '/urest/v1.1/deployment?deploymentStatus=SUITE_INSTALL&deploymentStatus=INSTALL_FINISHED',
          type: 'get',
          headers:{'X-AUTH-TOKEN': authorization},
          success: function (data) {
			instancelist = data;
              cb(data);
          },
          error: function (res) {
              console.log(res);
          }
      });
        
//     var data = fakeInstances11;
//     instancelist = data;
//     cb(data);
    }
    function requestSuiteInfo(cb) {
          $http({
              url: frontPath + '/urest/v1.1/suites',
              type: 'get',
              headers:{'X-AUTH-TOKEN': authorization},
              success: function (data) {
				  suitelist = data.suiteInfoList;
                  cb(suitelist);
              },
              error: function (res) {
                  console && console.log(res.statusText);
              }
          });
	
//      var data = fakeSuites;
//      suitelist = data;
//      cb(data);
    }
	function requestLabels(cb) {
          $http({
              url: frontPath + '/urest/v1.1/labels',
              type: 'get',
              headers:{'X-AUTH-TOKEN': authorization},
              success: function (data) {
              	for(var i=0;i<data.length;i++){
		        	if(!data[i].bind){
		        		data.splice(i,1);
		        		i--;
		        	}
		        }
                cb(data);
              },
              error: function (res) {
                  console && console.log(res.statusText);
              }
          });
//      var data = fakeLabels;
//      for(var i=0;i<data.length;i++){
//      	if(!data[i].bind){
//      		data.splice(i,1);
//      		i--;
//      	}
//      }
//      cb(data);
    }
	
	function requestCapabilities(editionId,suite,version, cb) {
		var shortLocale = language.substring(0,2);
		var reqUrl = frontPath + '/urest/v1.1/suite-feature/'+suite+'/'+version.version+version.features+'?lang-suffix='+shortLocale;
		if(editionId && editionId != null){
			reqUrl = reqUrl + "&editionId="+editionId
		}
          $http({
          	  url: reqUrl,
              type: 'get',
              headers:{'X-AUTH-TOKEN': authorization},
              success: function (data) {
                currentCap = data.suiteFeature;
        		suiteI18N = data.i18nMessage;
        		cb();
              },
              error: function (res) {
                  console.log(res);
              }
          });
//      var data = fakei18nConfigJson;
//      currentCap = data.suiteFeature;
//      suiteI18N = data.i18nMessage;
//      cb();
    }
	function requestExtLicense(cb) {
          $http({
              url: frontPath + '/urest/v1.1/license-manager/license',
              type: 'get',
              headers:{'X-AUTH-TOKEN': authorization},
              success: function (data) {
                  cb(data.feature);
              },
              error: function (res) {
              	  cb([]);
                  console.log(res);
              }
          });
//      var data = fakeLicense.feature;
//      cb(data);
    }
	function requestDeploymentId(cb) {
          $http({
              url: frontPath + '/urest/v1.1/deployment',
              type: 'post',
              headers:{
		              	'X-AUTH-TOKEN': authorization,
		              	'X-CSRF-TOKEN': csrfToken,
		              },
              success: function (data) {
                cb(data.uuid);
              },
              error: function (res) {
                console.log(res);
              }
          });
//			  var dep={
//			  	"uuid": "new11111111111111111111",
//			  	"status": "NEW",
//			  	"updatedTime": 1481076566393
//			  };
//        	cb(dep.uuid);
    }
	function requestLockId(cb) {
          $http({
              url: frontPath + '/urest/v1.1/license-manager/lock',
              type: 'get',
              headers:{'X-AUTH-TOKEN': authorization},
              success: function (data) {
                cb(data.lock.lockDetail);
              },
              error: function (res) {
              	cb([]);
                console.log(res);
              }
          });
//      var data = fakeLockId.lock.lockDetail;
//      cb(data);
    }
	function requestCsrfToken(cb) {
         $http({
            url: frontPath + '/urest/v1.1/csrf-token',
            type: 'get',
            cache:false,
            headers:{'X-AUTH-TOKEN': authorization},
            success: function (data) {
            	cb(data.csrfToken);
            },
            error: function (err) {
                console.log(err);
            }
        });
//      var data = {
//		    "csrfToken": "sauyfdgsdfgsdjkdsgfdg"
//		  };
//      cb(data.csrfToken);
   }
	
	
	//----------------------exp-------------------------

	function postFeature(deploymentId,cap,cb) {
        $http({
              url: frontPath + '/urest/v1.1/deployment/'+deploymentId+'/feature',
              type: 'post',
              data: JSON.stringify(cap),
              contentType:'application/json',
              headers:{
		              	'X-AUTH-TOKEN': authorization,
		              	'X-CSRF-TOKEN': csrfToken,
		              },
              success: function (data) {
                  cb();
              },
              error: function (res) {
                  console && console.log( res.statusText);
              }
        });
    }
	
    function checkIframeOK(iframeUrl, condition, cb) {
        var reTime = new Date().getTime() - condition.beginTime;
        console && console.log('checkIframeUrl cost: ' + reTime/1000);
        if(reTime >= condition.allTimes){
            console && console.log('checkIframeUrl end.');
            loadBundles(function(){
            	$("#next_btn").text(FOOTER_REFRESH_BUTTON);
            	$("#next_btn").removeAttr("disabled");
            });
            return cb();
        }
        console && console.log('try checkIframeUrl...');
        $http({
            url: iframeUrl,
            type: 'get',
            cache: false,
            headers:{'X-AUTH-TOKEN': authorization},
            success: function (data) {
            	loadBundles(function(){
	            	$("#next_btn").text(FOOTER_NEXT_BUTTON);
            		$("#next_btn").removeAttr("disabled");
            		$("#cancel_btn").show();
	            });
            	
            	suiteReady = true;
                cb();
            },
            error: function (res) {
               checktimer = setTimeout(function () {
                   checkIframeOK(iframeUrl, condition, cb);
               }, condition.delay);
            }
        });
    }
    
    function goExternalSite(){
    	window.open("http://autopass.hpeswlab.net/apsc");
    }
    function saveStep(step,cb){
//  	$http({
//        url: frontPath + '/urest/v1.1/cookie',
//        type: 'post',
//        headers:{'X-AUTH-TOKEN': authorization},
//        success: function (data) {
//          cb();
//        },
//        error: function (res) {
//          console.log(res);
//        }
//    	});
		console.log(step);
      	cb();
    }
    function requestEtcdStatus(cb){
    	$http({
          url: frontPath + '/urest/v1.1/cookie',
          type: 'post',
          headers:{
	              	'X-AUTH-TOKEN': authorization,
	              	'X-CSRF-TOKEN': csrfToken,
	              },
          success: function (data) {
            cb(data);
          },
          error: function (res) {
          	cb({});
            console.log(res);
          }
      	});
//		var data = fakeEtcdStatus;
//    	cb(data);
    }
	function loadBundles(cb) {
		jQuery.i18n.properties({
		    name:'Messages', 
		    path:'locale/', 
		    mode:'both',
		    language:language, 
		    callback: cb
		});
	}
	
	function getUrlParam(name){
	     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	     var r = window.location.search.substr(1).match(reg);
	     if(r!=null)return  unescape(r[2]); return null;
	}
     function registerOnNextHandler(handler) {
    	console.log("----------registerOnNextHandler--------------");
    	console.log(handler)
        onNextHandler = handler;
    }
    function registerOnBackHandler(handler) {
    	console.log("----------registerOnBackHandler--------------");
    	console.log(handler)
        onBackHandler = handler;
    }
    function registerOnCancelHandler(handler) {
    	console.log("----------registerOnCancelHandler--------------");
    	console.log(handler)
        onCancelHandler = handler;
    }
    function enableNext(enable) {
    	console.log("----------enableNext--------------");
    	console.log(enable)
    	if(enable){
    		$('#next_btn').removeAttr('disabled');
    	}else{
    		$('#next_btn').attr('disabled',"disabled");
    	}
    }
    function enableBack(enable) {
    	console.log("----------enableBack--------------");
    	console.log(enable)
    	if(enable){
    		$('#back_btn').removeAttr('disabled');
    	}else{
    		$('#back_btn').attr('disabled',"disabled");
    	}
    }
    function enableCancel(enable) {
    	console.log("----------enableCancel--------------");
    	console.log(enable)
    	if(enable){
    		$('#cancel_btn').removeAttr('disabled');
    	}else{
    		$('#cancel_btn').attr('disabled',"disabled");
    	}
    }
</script>



</body>

</html>